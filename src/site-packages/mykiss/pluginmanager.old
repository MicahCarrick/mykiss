import os

from gettext import gettext as _

from gi.repository import GObject
from gi.repository import Gtk
from gi.repository import GdkPixbuf

import icons

class PluginManager(Gtk.Grid):
    """
    A composite widget for enabling, disabling, and configuring plugins.
    
    Args:
        data_dir: The directory in which to find application data.
        engine: A PluginEngine instance.
    """
    def __init__(self, data_dir, engine=None):
        Gtk.Grid.__init__(self)
        self.set_orientation(Gtk.Orientation.VERTICAL)
        self._data_dir = data_dir
        self._engine = engine
        self._treeview = self._init_treeview()

        scrolled = Gtk.ScrolledWindow()
        scrolled.set_shadow_type(Gtk.ShadowType.IN)
        scrolled.add(self._treeview)
        
        self.add(self._init_toolbar())
        self.add(scrolled)        
        self.show_all()
        
        # default plugin icon
        self._plugin_pixbuf = self.render_icon_pixbuf(icons.STOCK_PLUGIN,
                                                      Gtk.IconSize.DND)
        self.refresh_plugin_list()
    
    @GObject.property
    def engine(self):
        return self._engine
        
    def _init_toolbar(self):
        """
        Return a Gtk.Toolbar based on the UI definitions in plugin_manager.ui.
        """
        manager = Gtk.UIManager()
        #accelgroup = manager.get_accel_group()
        #self.add_accel_group(accelgroup)
        
        actions = Gtk.ActionGroup("PluginActions")
        actions.add_actions([
            ('About', Gtk.STOCK_ABOUT, "About", None, 
                _("About the plugin"), 
                self.on_about_activate),
            ('Preferences', Gtk.STOCK_PREFERENCES, "Preferences", None, 
                _("Plugin preferences"), 
                self.on_preferences_activate),
        ])
        manager.insert_action_group(actions)
        
        ui_file = os.path.join(self._data_dir, "ui", "plugin_manager.ui")
        manager.add_ui_from_file(ui_file)
        toolbar = manager.get_widget("ui/PluginManagerToolbar")
        #context = toolbar.get_style_context()
        #context.add_class(Gtk.STYLE_CLASS_PRIMARY_TOOLBAR)
        return toolbar 
        
    def _init_treeview(self):
        """
        Return a Gtk.Treeview representing the list of installed plugins.
        """
        treeview = Gtk.TreeView()
        treeview.set_headers_visible(False)
        self._model = Gtk.ListStore(int, GdkPixbuf.Pixbuf, str, str, object, str)
        treeview.set_model(self._model)
        treeview.set_vexpand(True)
        treeview.set_hexpand(True)
        treeview.set_valign(Gtk.Align.FILL)
        treeview.set_halign(Gtk.Align.FILL)
        treeview.set_tooltip_column(5)
        column = Gtk.TreeViewColumn("Plugin")
        # toggle button
        cell = Gtk.CellRendererToggle()
        cell.set_activatable(True)
        cell.connect("toggled", self.on_plugin_toggled, (self._model, 0))
        column.pack_start(cell, False)
        column.add_attribute(cell, "active", 0)
        
        # icon
        cell = Gtk.CellRendererPixbuf()
        column.pack_start(cell, False)
        column.add_attribute(cell, 'pixbuf', 1)
        
        # plugin name
        cell = Gtk.CellRendererText()
        column.pack_start(cell, True)
        column.add_attribute(cell, "markup", 2)
        treeview.append_column(column)
        
        return treeview
    
    def on_plugin_toggled(self, renderer, path, data=None):
        """ 
        A checkbox for enabling/disabling a plugin was toggled. 
        """
        model, column = data
        model[path][column] = not model[path][column]
        if model[path][column]:
            self.engine.enable(model[path][4])
        else:
            self.engine.disable(model[path][4])
    
    def on_about_activate(self, action, data=None):
        pass
    
    def on_preferences_activate(self, action, data=None):
        pass
    
    def refresh_plugin_list(self):
        model = self._model
        for plugin in self.engine.installed_plugins:
            pixbuf = self.render_icon_pixbuf(plugin.stock_id, Gtk.IconSize.DND)
            if not pixbuf:
                pixbuf = self._plugin_pixbuf
            markup = "<b>%s</b>\n%s" % (plugin.name, plugin.description)
            enabled = self.engine.is_enabled(plugin)
            self._model.append((enabled, pixbuf, markup, plugin.version_string, 
                                plugin, plugin.plugin_file))
        
